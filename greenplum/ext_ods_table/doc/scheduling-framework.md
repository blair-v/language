# Scheduling framework

> Flexible task scheduling framework

date | version | description | author 
:--- | :-- |:--- | :-- |
2017-01-20 | 1.0 | scheduling framework | blair

> 该 框架产生的初衷，主要是为了调度离线大数据分析的任务，当然它也适用于任何可以在linux上调度的离线任务。

## 目标

+ 1. 提供一些 best practice
+ 2. 提高各模块结构及代码的一致性
+ 3. 降低开发新模块的成本
+ 4. 便于离线数据拉取及分析

```
  这是一个 shell、python 等语言写成的灵活调度框架.
     该示例模块架 适用于离线分析，每天跑的crontab任务，或者是每周、每月跑的任务
```

## 1. 框架功能

 1. 调度 linux 可执行的 shell 脚本。
 2. 如有多个任务，则各个调度的 任务 可以并行执行。
 3. 解决 任务与任务之间，模块与模块 的相互依赖关系的检测，与前后执行的关系。
 4. 日志统一，查看日志可到 log 目录，进而容易定位问题。
 5. 任务失败自动发送报警邮件，并显示失败的任务日志位置。
 6. 每个任务不会自动重复执行，开始执行与执行完毕均会生成相应标志文件，标志完成文件，方便下游检测。

## 2. 代码规范

+ 1. 基本的编程规范不再赘述  (请考虑你的 backup person 不痛苦的原则)        
+ 2. 每个模块建议给出准确的输入、输出格式定义注释说明.

## 3. 结构规范

### 3.1 目录结构

+ 每个模块一个根目录包括如下子目录

| 目录 | 说明|
| :--- | :-- |
| ── alert | 发送报警的脚本 |  
| ── conf | 配置文件 |
| ──create_table | 建表语句 (如无，则不需要该目录) |
| ── crontab_job | crontab 任务脚本。(crontab任务脚本以crontab_job为前缀，调用script主脚本) |
| ── data | 数据文件。(如没有数据则不需要该目录) |
| ── ktrs | ktr 与 kjb 文件。(如无kettle任务则不需要该目录) |
| ── flag | 标记文件。(标志该模块已经开始运行，或者运行完毕) |
| ── jar | jar包 (如无，则不需要该目录)  |
| ── log | 日志文件。 (如脚本失败可根据log追查定位失败原因) |
| ── script | 主脚本文件 |
| ── util | utility脚本。(主要包含工具类脚本。 如 log重定向、hive check封装、初始化env等)
+ script目录 主要存放 shell 脚本，有需要也存放 python 脚本。
+ 如果该模块，script目录脚本较多，􏰀可以在 script dir之下建立子目录􏰀如􏰂 :

        ├── script
          ├── sub_module_1 子模块目录 
          ├── sub_module_2 子模块目录

> crontab_job 目录脚本，主要就是 检测需要的依赖，调度 script 下主脚本，生成执行标志文件 和 执行完成标志文件等
> 
> script 目录脚本，主要是你的主脚本 (包含你的主业务逻辑)
          
### 3.2 项目模板 

+ 提供公共的项目模板. 􏰀统一shell脚本代码􏰄结构􏰄 日志􏰄配置规范􏰁 等
+ 脚本调用任务可参考 :
    
    ```
    http://gitlab.***/backend/ext_ods_table.git
    ``` 

> 这是一个参考 demo ，尽量不要向该分支提交代码。
   
+ 1). 配置文件 (conf目录下)

   ```
   default.conf􏰂 配置公共参数􏰂程序路径􏰄hadoop用户、以及其他不经常改变的 var 等􏰁
   vars.conf 配置任务参数􏰂, 常用变量 等􏰁
   alert.conf􏰂 配置邮件和短信报警接收人􏰁 
```

+ 2). 报警规范

  ```
  check_success 为封装好的报警函数。 检测上一条语句返回状态，返回0执行成功，如执行失败则触发报警。
  (发报警邮件标题以 模块名--任务脚本路径名--任务状态及原因-日期 来设置。便于快速定位问题)
  ```

## 4. 如何开发

1. 登开发机，并确定所用账号已加入到 deploy group
2. cd /***/online/demo 下，在同级目录下，复制该demo
3. cd (your module) 进行配置和开发工作 (demo中不需要的演示文件可删除)

> 每次执行主脚本，都会自动在 log 目录，产生一个日志文件。(如你一定要自己指定kettle的日志输出文件，则指定到 log/ktrs 目录下)
> 
> demo 演示了如何控制上下游依赖的流程，以及如何并行执行任务，如何执行任务等。
> 
> 开发之前，请熟悉本文档，并阅读框架demo代码，熟悉该调度框架的基本原理和使用方法。

注 : 如有其他问题，再商议

