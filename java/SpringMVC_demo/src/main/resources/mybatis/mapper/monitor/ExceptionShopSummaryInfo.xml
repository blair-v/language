<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.x.dmt.dao.monitor.ExceptionShopSummaryInfoDAO">

    <insert id="addExceptionShopSummaryInfoList" parameterType="java.util.List" flushCache="true">
        insert into shop_exception_summary (
            id,
            shop_id,
            shop_name,
            shop_full_name,
            except_type,
            except_desc,
            stat_date,
            create_time,
            alert_type,
            status_type,
            check_type
        )
        values
        <foreach collection="list" item="e" index="index" separator=",">
            (
            #{e.id},
            #{e.shopId},
            #{e.shopName},
            #{e.shopFullName},
            #{e.exceptType},
            #{e.exceptDesc},
            #{e.statDate},
            #{e.createTime},
            #{e.alertType},
            #{e.statusType},
            #{e.checkType}
            )
        </foreach>
    </insert>

    <select id="getExceptionShopSummaryInfoListByStatDateCheckType" parameterType="java.util.Map" resultType="ExceptionShopSummaryInfo">
        <![CDATA[
            SELECT
              id as id,
              shop_id as shopId,
              shop_name as shopName,
              shop_full_name as shopFullName,
              except_type as exceptType,
              except_desc as exceptDesc,
              stat_date as statDate,
              create_time as createTime,
              alert_type as alertType,
              status_type as statusType,
              check_type as checkType
            FROM shop_exception_summary ses
            WHERE stat_date = #{stat_date}
            AND check_type = #{check_type}
        ]]>
    </select>

    <update id="updateExceptionShopSummaryInfoListStatusType" parameterType="java.util.Map" flushCache="true">
        <![CDATA[
            UPDATE
              shop_exception_summary
            SET status_type = #{status_type},
                create_time = SYSDATE()
            WHERE id = #{id}
      ]]>

    </update>

    <select id="getExceptionShopIdInfos" parameterType="java.util.Map" resultType="ShopIdInfo">
        <![CDATA[
            select
              DISTINCT sesy.shop_id as ShopId
            from shop_exception_summary sesy
             WHERE sesy.stat_date = #{stat_date}
             AND sesy.check_type = #{check_type}
             AND sesy.status_type = #{status_type}
        ]]>
    </select>
   <!--AND sesy.alert_type = #{alert_type}  Regardless of whether the shop_summary alarm, no matter the detail order-->

</mapper>
