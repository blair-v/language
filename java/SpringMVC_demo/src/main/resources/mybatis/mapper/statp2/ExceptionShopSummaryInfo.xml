<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.x.dmt.dao.statp2.StatExceptionShopSummaryInfoDAO">

    <select id="getExceptionShopSummaryInfo" parameterType="java.util.Map" resultType="ExceptionShopSummaryInfo">
        <![CDATA[
          SELECT
            t1.businessId as shopId,
            t4.name as shopName,
            t4.fullName as shopFullName,
            1 as exceptType,
            'Transaction Amount Summary Exception' as exceptDesc,
            #{stat_date} as statDate,
            SYSDATE() as createTime
          FROM
                (SELECT
                  transactionAmount,
                  businessId
                FROM stat_order
                WHERE statDate = #{stat_date}) t1
              LEFT JOIN
                (SELECT
                  SUM(transactionAmount) as t2_total_transactionAmount,
                  businessId
                FROM stat_transaction WHERE statDate = #{stat_date} GROUP BY businessId) t2
               ON t1.businessId = t2.businessId
              LEFT JOIN
                 (SELECT
                   SUM(transactionAmount) as t3_total_transactionAmount,
                   businessId
                 FROM stat_order_transaction where statDate = #{stat_date} GROUP BY businessId) t3
               ON t1.businessId = t3.businessId
              LEFT JOIN
                shop t4
               ON t1.businessId=t4.id
          WHERE t1.transactionAmount <> if(t2.t2_total_transactionAmount is null,0,t2.t2_total_transactionAmount)
               OR t1.transactionAmount <> if(t3.t3_total_transactionAmount is null,0,t3.t3_total_transactionAmount)
        ]]>
    </select>
</mapper>
